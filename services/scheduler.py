import logging
import datetime
import pytz
import random
from aiogram import Bot
from sqlalchemy.ext.asyncio import async_sessionmaker

from database.crud import UserCRUD
from services.ai_manager import AIManager

logger = logging.getLogger(__name__)

async def send_morning_motivation(bot: Bot, session_pool: async_sessionmaker):
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å.
    –í—ã–±–∏—Ä–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö notification_time —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º —á–∞—Å–æ–º.
    """
    # 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Å –≤ –ú–æ—Å–∫–≤–µ
    msk_tz = pytz.timezone("Europe/Moscow")
    now_hour = datetime.datetime.now(msk_tz).hour
    
    logger.info(f"‚è∞ Scheduler tick: Checking users for {now_hour}:00")

    async with session_pool() as session:
        # 2. –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫—Ç–æ –∂–¥–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–µ–π—á–∞—Å
        users = await UserCRUD.get_users_by_notification_hour(session, now_hour)
        
        if not users:
            return

        # 3. –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –∏–∑ —Å–ø–∏—Å–∫–∞
        import random

        motivations = [
            "–¢–≤–æ–µ —Ç–µ–ª–æ ‚Äî —ç—Ç–æ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Ç–≤–æ–∏—Ö –ø—Ä–∏–≤—ã—á–µ–∫. –ù–∞—á–Ω–∏ –¥–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ! üí™",
            "–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ —Å–µ–≥–æ–¥–Ω—è ‚Äî –±–æ–ª—å—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≤—Ç—Ä–∞. –ü–æ–≥–Ω–∞–ª–∏ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É? üî•",
            "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –æ—á–µ–Ω—å –Ω–µ —Ö–æ—á–µ—Ç—Å—è, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Ç–æ–≥–æ, —á–µ–≥–æ —Ö–æ—á–µ—à—å. üèÜ",
            "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –¢–≤–æ–π –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç ‚Äî —ç—Ç–æ —Ç—ã —Å–∞–º. –†–∞–∑–¥–≤–∏–Ω—å –≥—Ä–∞–Ω–∏—Ü—ã! üöÄ",
            "–°–∏–ª–∞ –Ω–µ –≤ –º—ã—à—Ü–∞—Ö, —Å–∏–ª–∞ –≤ –≥–æ–ª–æ–≤–µ. –ü—Ä–æ—Å–Ω–∏—Å—å –∏ –¥–æ–∫–∞–∂–∏ —Å–µ–±–µ, –Ω–∞ —á—Ç–æ —Ç—ã —Å–ø–æ—Å–æ–±–µ–Ω! üß†‚ú®",
            "–£—Å–ø–µ—Ö –Ω–µ –ø–∞–¥–∞–µ—Ç —Å –Ω–µ–±–∞, –æ–Ω –∫—É–µ—Ç—Å—è –≤ –∑–∞–ª–µ. –ñ–¥—É —Ç–µ–±—è –Ω–∞ –∑–∞–Ω—è—Ç–∏–∏! üèãÔ∏è‚Äç‚ôÇÔ∏è",
            "–ù–µ –∂–¥–∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è, —Å–æ–∑–¥–∞–≤–∞–π –µ–≥–æ —Å–≤–æ–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏. –í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å! ‚ö°",
            "–ö–∞–∂–¥–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç —Ç–µ–±—è –∫ –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–∏ —Å–µ–±—è. –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è! üìà",
            "–¢–≤–æ–∏ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è –Ω–µ —Å–æ–∂–≥—É—Ç –∫–∞–ª–æ—Ä–∏–∏. –í—Å—Ç–∞–≤–∞–π –∏ —Å–¥–µ–ª–∞–π —ç—Ç–æ! üëä",
            "–°–µ–≥–æ–¥–Ω—è ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –≤—á–µ—Ä–∞! üåü",
            "–ü–æ–±–µ–¥–∞ –ª—é–±–∏—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö. –¢—ã –≥–æ—Ç–æ–≤ –≤—ã–ª–æ–∂–∏—Ç—å—Å—è –Ω–∞ –≤—Å–µ 100? ü•á",
            "–¢–≤–æ–µ –±—É–¥—É—â–µ–µ '–Ø' —Å–∫–∞–∂–µ—Ç —Ç–µ–±–µ —Å–ø–∞—Å–∏–±–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É. ü§ù",
            "–ë–æ–ª—å –≤—Ä–µ–º–µ–Ω–Ω–∞, —Ç—Ä–∏—É–º—Ñ –≤–µ—á–µ–Ω. –û—Å—Ç–∞–≤—å –ª–µ–Ω—å –≤ –∫—Ä–æ–≤–∞—Ç–∏! ‚è≥üî•",
            "–ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π —Å–µ–±—è —Å –¥—Ä—É–≥–∏–º–∏. –°—Ä–∞–≤–Ω–∏–≤–∞–π —Å–µ–±—è —Å —Ç–µ–º, –∫–µ–º —Ç—ã –±—ã–ª –≤—á–µ—Ä–∞. üîÑ",
            "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —Ç–æ, –æ —á–µ–º –¥—Ä—É–≥–∏–µ –∑–∞–≤—Ç—Ä–∞ –±—É–¥—É—Ç —Ç–æ–ª—å–∫–æ –º–µ—á—Ç–∞—Ç—å. üíé",
            "–ü–æ–º–Ω–∏, –∑–∞—á–µ–º —Ç—ã –Ω–∞—á–∞–ª. –¢–≤–æ—è —Ü–µ–ª—å –±–ª–∏–∂–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è! üéØ",
            "–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä—è–º–∞—è –ª–∏–Ω–∏—è. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ! üìâüìà",
            "–¢–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ ‚Äî —ç—Ç–æ —Å–∞–º–∞—è –≤—ã–≥–æ–¥–Ω–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è. –ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π –≤—Ä–µ–º—è –≤ —Å–µ–±—è! üçé",
            "–î–≤–∏–≥–∞–π—Å—è –≤–ø–µ—Ä–µ–¥, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ–º–ø –∫–∞–∂–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω—ã–º. –¢—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–±–≥–æ–Ω—è–µ—à—å —Ç–µ—Ö, –∫—Ç–æ –ª–µ–∂–∏—Ç –Ω–∞ –¥–∏–≤–∞–Ω–µ. üê¢üí®",
            "–í–µ—Ä—å –≤ —Å–µ–±—è —Ç–∞–∫ –∂–µ —Å–∏–ª—å–Ω–æ, –∫–∞–∫ —è –≤–µ—Ä—é –≤ —Ç–≤–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª. –¢—ã –º–∞—à–∏–Ω–∞! ü§ñüí™"
        ]
        
        text = random.choice(motivations)

        # 4. –†–∞—Å—Å—ã–ª–∞–µ–º
        count = 0
        for user in users:
            try:
                msg = f"‚òÄÔ∏è <b>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!</b>\n\n{text}"
                await bot.send_message(user.telegram_id, msg, parse_mode="HTML")
                count += 1
            except Exception as e:
                logger.warning(f"Failed to send to {user.telegram_id}: {e}")
        
        logger.info(f"‚úÖ Sent motivation to {count} users.")
import logging
import random
from aiogram import Bot
from sqlalchemy.ext.asyncio import async_sessionmaker
from database.crud import UserCRUD

logger = logging.getLogger(__name__)

# –°–ø–∏—Å–æ–∫ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è
QUOTES = [
    "üöÄ –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –æ—á–µ–Ω—å –Ω–µ —Ö–æ—á–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Ç–æ–≥–æ, —á–µ–≥–æ –æ—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è –¥–æ—Å—Ç–∏—á—å.",
    "üí™ –¢–≤–æ–µ —Ç–µ–ª–æ –º–æ–∂–µ—Ç –≤—Å–µ. –≠—Ç–æ —Ç–≤–æ–π –º–æ–∑–≥ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å.",
    "üåü –ù–µ –∂–¥–∏ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞. –ë–µ—Ä–∏ –º–æ–º–µ–Ω—Ç –∏ –¥–µ–ª–∞–π –µ–≥–æ –∏–¥–µ–∞–ª—å–Ω—ã–º.",
    "üî• –ë–æ–ª—å, –∫–æ—Ç–æ—Ä—É—é —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–≥–æ–¥–Ω—è, –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—Å—è –≤ —Å–∏–ª—É, –∫–æ—Ç–æ—Ä—É—é —Ç—ã –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å –∑–∞–≤—Ç—Ä–∞.",
    "üèÉ‚Äç‚ôÇÔ∏è –î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ª—É—á—à–µ, —á–µ–º –µ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ.",
    "üíé –¢—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–µ–ª–∏–∫–∏–º, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å. –ù–æ —Ç—ã –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∞—Ç—å, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å –≤–µ–ª–∏–∫–∏–º."
]

async def send_morning_motivation(bot: Bot, session_pool: async_sessionmaker):
    """
    –†–∞—Å—Å—ã–ª–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
    """
    try:
        async with session_pool() as session:
            users = await UserCRUD.get_all_users(session)
            
        if not users:
            return

        quote = random.choice(QUOTES)
        message_text = f"‚òÄÔ∏è <b>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –ê—Ç–ª–µ—Ç!</b>\n\n<i>{quote}</i>\n\n–ù–µ –∑–∞–±—É–¥—å —Å–µ–≥–æ–¥–Ω—è –∑–∞–≥–ª—è–Ω—É—Ç—å –≤ –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫! üëá"

        count = 0
        for user in users:
            try:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                await bot.send_message(user.telegram_id, message_text)
                count += 1
            except Exception as e:
                # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —é–∑–µ—Ä—É {user.telegram_id}: {e}")
        
        logger.info(f"üì¢ –£—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {count} —Å–æ–æ–±—â–µ–Ω–∏–π.")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Ä–∞—Å—Å—ã–ª—å—â–∏–∫–µ: {e}")